<!DOCTYPE html>
<html>
<head>
  <title>SCUTTLE GUI</title>
  <script src="http://beagleboard.org/static/bonescript.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/svg.js/2.7.1/svg.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flot/0.8.3/jquery.flot.min.js"></script>
  <script>  
var ran = false;
setTargetAddress('192.168.7.2:8000', {initialized: run});

function run() {
  if(ran) return;
  ran = true;
  var b = require('bonescript');
  var element = SVG.get('mycircle');
  setTimeout(doRead, 100);
  
  function doRead() {
	  b.readTextFile('/sys/class/gpio/gpio69/value', onRead);
  }

	function onRead(x) {
  	if(x.err) {
		  b.writeTextFile('/sys/class/gpio/export', '69');
    } else if(x.data == 1) {
			element.fill('#f00');
    } else {
			element.fill('#0f0');
    }
	  setTimeout(doRead, 100);  
    }
	  
    var POT = 'ADC_3';

    var ADCcontainer = $("#ADCmyplot");
    var ADCtotalPoints = ADCcontainer.outerWidth() / 2 || 250;
    var ADCdata = [];
    var ADCplotOptions = {
        series: {
            shadowSize: 0
        },
        yaxis: {
            min: 0,
            max: 1
        },
        xaxis: {
            min: 0,
            max: ADCtotalPoints,
            show: false
        }
    };
    var ADCplot = $.plot(ADCcontainer, ADCgetData(), ADCplotOptions);

    var ACCELcontainer = $("#ACCELmyplot");
    var ACCELtotalPoints = ACCELcontainer.outerWidth() / 2 || 250;
    var ACCELdata = [];
    var ACCELplotOptions = {
        series: {
            shadowSize: 0
        },
        yaxis: {
            min: -20000,
            max: 20000
        },
        xaxis: {
            min: 0,
            max: ACCELtotalPoints,
            show: false
        }
    };
    var ACCELplot = $.plot(ACCELcontainer, ACCELgetData(), ACCELplotOptions);

    ADCdrawGraph();
    ACCELdrawGraph();

    function ACCELdrawGraph() {
	//var IMUX = '/sys/bus/iio/devices/iio:device1/in_accel_x_raw';
	var IMUX = '/sys/bus/iio/devices/iio:device2/in_magn_x_raw';
        ACCELplot.setData(ACCELgetData());
        ACCELplot.draw();
        b.readTextFile(IMUX, ACCELonRead);
    }
	
    function ADCdrawGraph() {
        ADCplot.setData(ADCgetData());
        ADCplot.draw();
	b.analogRead(POT, ADConRead);
    }

    function ACCELonRead(x) {
        ACCELpushData(x.data.trim());
        setTimeout(ACCELdrawGraph, 20);
    }

    function ADConRead(x) {
	ADCpushData(x.value);
        setTimeout(ADCdrawGraph, 20);
    }

    function ACCELpushData(y) {
        if (ACCELdata.length && (ACCELdata.length + 1) > ACCELtotalPoints) {
            ACCELdata = ACCELdata.slice(1);
        }
        if (ACCELdata.length < ACCELtotalPoints) {
            ACCELdata.push(y);
        }
    }

    function ADCpushData(y) {
        if (ADCdata.length && (ADCdata.length + 1) > ADCtotalPoints) {
            ADCdata = ADCdata.slice(1);
        }
        if (ADCdata.length < ADCtotalPoints) {
            ADCdata.push(y);
        }
    }

    function ACCELgetData() {
        var res = [];
        for (var i = 0; i < ACCELdata.length; ++i) {
            res.push([i, ACCELdata[i]]);
        }
        var series = [{
            data: res,
            lines: {
                fill: true
            }
        }];
        return series;
    }

    function ADCgetData() {
        var res = [];
        for (var i = 0; i < ADCdata.length; ++i) {
            res.push([i, ADCdata[i]]);
        }
        var series = [{
            data: res,
            lines: {
                fill: true
            }
        }];
        return series;
    }
}  
  </script>
</head>
<body>

<h1>Testing SVG functionality</h1>

<svg width="100" height="100">
   <circle id="mycircle" cx="50" cy="50" r="40" stroke="#aaa" stroke-width="4" fill="#aaa" />
   Sorry, your browser does not support inline SVG.
</svg> 
	
<h1>ADC_3</h1> 
<div id="ADCmyplot" style="width:500px;height:250px;"></div>
	
	
<h1>ACCEL_X</h1> 
<div id="ACCELmyplot" style="width:500px;height:250px;"></div>

</body>
</html>
